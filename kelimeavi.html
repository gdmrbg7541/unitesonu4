<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelime AvÄ±</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Markazi+Text:wght@400;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Temel Sayfa Stilleri --- */
        :root {
            --accent-color: #0d6efd; 
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
            --font-arabic: 'Markazi Text', 'Noto Naskh Arabic', 'Tahoma', 'Arial', sans-serif;
            
            /* VarsayÄ±lan (MasaÃ¼stÃ¼/Yatay) boyutlar */
            --grid-size-cols: 10;
            --grid-size-rows: 10; /* Kare Izgara */
        }

        body {
            font-family: var(--font-arabic);
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            font-weight: 400;
        }

        /* --- Ana Etkinlik AlanÄ± --- */
        .activity-container {
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 90vw;
            height: calc(90vw * 9 / 16); /* 16:9 */
            max-height: 90vh;
            max-width: calc(90vh * 16 / 9); /* 16:9 */
        }
        
        /* --- Header --- */
        .header {
            padding: 15px 25px;
            border-bottom: 1px solid #dee2e6;
            display: grid;
            grid-template-areas: "replay instruction back"; 
            grid-template-columns: auto 1fr auto; 
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        #instruction-text {
            grid-area: instruction;
            text-align: center; 
            font-size: 2.2rem; 
            font-weight: 700;
            color: #555;
        }

        .header-button-container {
            display: flex;
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
        }
        .header-button-container.left { grid-area: replay; justify-content: flex-start; }
        .header-button-container.right { grid-area: back; justify-content: flex-end; }

        .icon-button {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
            border-radius: 1.5vmin;
            cursor: pointer;
            width: clamp(40px, 8vmin, 55px);
            height: clamp(40px, 8vmin, 55px);
            padding: 0;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; 
        }
        .icon-button:hover {
            background: #e0e0e0;
        }
        .icon-button svg {
            width: clamp(24px, 5vmin, 30px);
            height: clamp(24px, 5vmin, 30px);
            fill: currentColor;
        }
        
        /* --- Tam Ekran DÃ¼ÄŸmesi --- */
        #fullscreen-btn {
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
            border-radius: 1.5vmin;
            cursor: pointer;
            width: clamp(40px, 8vmin, 55px);
            height: clamp(40px, 8vmin, 55px);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }
        #fullscreen-btn:hover {
            background: #e0e0e0;
        }
        #fullscreen-btn svg {
            width: clamp(24px, 5vmin, 30px);
            height: clamp(24px, 5vmin, 30px);
            fill: currentColor;
        }
        #fullscreen-btn .icon-open { display: block; }
        #fullscreen-btn .icon-close { display: none; }
        body.fullscreen #fullscreen-btn .icon-open { display: none; }
        body.fullscreen #fullscreen-btn .icon-close { display: block; }


        /* --- AsÄ±l Etkinlik AlanÄ± --- */
        .activity-area {
            flex-grow: 1;
            padding: 15px 5px; 
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            gap: 15px;
            justify-content: flex-start;
            align-items: center;
        }

        /* --- Izgara Stilleri --- */
        #puzzle-grid-container {
            flex-grow: 1;
            height: 100%;
            max-height: 100%; 
            aspect-ratio: var(--grid-size-cols) / var(--grid-size-rows); 
            display: grid;
            grid-template-columns: repeat(var(--grid-size-cols), 1fr);
            grid-template-rows: repeat(var(--grid-size-rows), 1fr);
            gap: 0; 
            background-color: #ccc; 
            border: 3px solid #666; 
            border-radius: 8px;
            overflow: hidden; 
            user-select: none;
            box-sizing: border-box; 
        }
        
        .grid-cell {
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4.5vmin; 
            font-weight: 400;
            color: #333;
            cursor: pointer;
            border-bottom: 3px solid #999; 
            border-left: 3px solid #999; 
            box-sizing: border-box;
            
            /* --- DÃœZELTME: ARAPÃ‡A HARF HÄ°ZALAMA --- */
            /* ArapÃ§a harflerin tabanÄ± biraz aÅŸaÄŸÄ±da olduÄŸu iÃ§in gÃ¶rsel olarak 
               yukarÄ± itmek gerekir. */
            padding-bottom: 1.2vmin; 
            line-height: 1;
        }
        #puzzle-grid-container .grid-cell:nth-child(var(--grid-size-cols)n) {
            border-right: none;
        }
        #puzzle-grid-container .grid-cell:nth-child(-n + var(--grid-size-cols)) {
            border-top: none;
        }

        /* SeÃ§im VurgularÄ± */
        .grid-cell.selecting {
            background-color: #b3d4fc; 
            transition: background-color 0.05s ease;
        }
        
        .grid-cell.found {
            color: white;
            transition: background-color 0.3s ease;
        }

        /* --- Kelime Listesi Stilleri --- */
        #word-list-container {
            flex-basis: auto; 
            width: 100%;
            flex-shrink: 0;
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #word-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 10px 20px; 
        }

        .word-list-item {
            font-size: 1.8rem; 
            font-weight: 700;
            color: #555;
            transition: all 0.3s ease;
            border-left: 1px solid #ccc;
            padding-left: 15px;
            
            /* --- DÃœZELTME: LÄ°STE HÄ°ZALAMA --- */
            display: flex;
            align-items: center;
            gap: 5px;
            line-height: 1.2;
        }
        
        .word-list-item:last-child {
            border-left: none;
            padding-left: 0;
        }
        
        .word-list-item.found {
            text-decoration: line-through;
            opacity: 0.7;
        }


        /* --- Geri Bildirim EkranÄ± --- */
        .feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 15rem;
            z-index: 200;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-direction: column;
        }
        .feedback-overlay.show {
            visibility: visible;
            opacity: 1;
        }
        .feedback-overlay .correct { color: var(--success-color); }
        
        #replay-button-end {
            display: none; 
            font-size: 4.5rem; 
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: transform 0.2s ease, background-color 0.2s ease;
            margin-top: 20px;
        }
        #replay-button-end:hover {
            transform: rotate(-90deg);
            background-color: #f0f0f0;
        }
        
        /* --- Ana KonteynÄ±rÄ±n Tam Ekran DavranÄ±ÅŸÄ± --- */
        body.fullscreen .activity-container {
            width: 100vw;
            height: calc(100vw * 9 / 16);    
            max-height: 100vh;
            max-width: calc(100vh * 16 / 9);
            border-radius: 0;
            box-shadow: none;
        }

        /* --- BAÅLANGIÃ‡ EKRANI (Start Screen) --- */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d6efd; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999; 
            color: white;
            transition: opacity 0.5s ease;
        }

        #start-btn {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 15px 40px;
            font-size: 2.5rem;
            font-family: var(--font-arabic);
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 0 #d39e00;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        #start-btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #d39e00;
        }
        
        /* --- DÃ–NDÃœRME UYARISI (Dikey Mod Engeli) --- */
        #rotate-message {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #212529;
            z-index: 10000; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .phone-icon {
            width: 60px;
            height: 100px;
            border: 3px solid white;
            border-radius: 8px;
            position: relative;
            margin-bottom: 20px;
            animation: rotate-phone 2s infinite ease-in-out;
        }
        
        .phone-icon::after {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        @keyframes rotate-phone {
            0%, 10% { transform: rotate(0deg); }
            40%, 60% { transform: rotate(-90deg); }
            90%, 100% { transform: rotate(-90deg); }
        }

        /* --- MOBÄ°L VE DÄ°KEY ALGILAMA --- */
        @media only screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            .activity-container { display: none !important; }
            #start-screen { display: none; }
        }
        
        @media only screen and (orientation: landscape) and (max-height: 500px) {
             .header { padding: 5px 15px; }
             #instruction-text { font-size: 1.5rem; }
             .icon-button { width: 35px; height: 35px; font-size: 1.5rem; }
             .activity-area { padding: 5px; gap: 5px; }
             #word-list-container { padding: 5px; }
             .word-list-item { font-size: 1.4rem; padding-left: 10px; }
             .activity-container {
                height: 95vh;
                width: calc(95vh * 16 / 9);
             }
        }

    </style>
</head>
<body>

    <div id="rotate-message">
        <div class="phone-icon"></div>
        <h2>ÙŠØ±Ø¬Ù‰ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø²</h2>
        <p>LÃ¼tfen telefonu yan Ã§evirin</p>
    </div>

    <div id="start-screen">
        <button id="start-btn" onclick="startAndFullscreen()">Ø§ÙØ¨Ù’Ø¯ÙØ£Ù’ </button>
    </div>

    <div class="activity-container">
        
        <div class="header">
            <div class="header-button-container left">
                <button class="icon-button" id="replay-button-header" onclick="restartGame()">ğŸ”„</button>
            </div>
            
            <div id="instruction-text">Ø§ÙØ¨Ù’Ø­ÙØ«Ù’ Ø¹ÙÙ† Ø§Ù„ÙƒÙÙ„ÙÙ…Ø§Øªâ€«.â€¬</div>

            <div class="header-button-container right">
                <button id="fullscreen-btn">
                    <svg class="icon-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M5 10h2V7h3V5H5v5zM14 5v2h3v3h2V5h-5zM5 19v-5h2v3h3v2H5zM14 19v-2h3v-3h2v5h-5z"/>
                    </svg>
                    <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                    </svg>
                </button>
                
                <a href="index.html" class="icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                </a>
            </div>
        </div>

        <div class="activity-area">
            
            <div id="word-list-container">
                <ul id="word-list">
                </ul>
            </div>
            
            <div id="puzzle-grid-container" oncontextmenu="return false;">
            </div>
            
        </div>

        <div class="feedback-overlay" id="feedback-overlay">
            <span id="feedback-icon"></span>
            <button id="replay-button-end" onclick="restartGame()">ğŸ”„</button>
        </div>

    </div>

<script>
    // --- Kelime Verisi ---
    const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997', '#0d6efd', '#6f42c1', '#e83e8c'];
    
    // TÃœM SEVÄ°YELER VERÄ°SÄ° 
    const allLevelsData = [
        // Seviye 1: Mevsimler ve Hava Durumu
        [
            { word: 'ØµÙÙŠÙ’Ù', color: colors[0], emoji: 'â˜€ï¸' },    
            { word: 'Ø´ÙØªÙØ§Ø¡', color: colors[1], emoji: 'â„ï¸' },    
            { word: 'Ø±ÙØ¨ÙÙŠØ¹', color: colors[2], emoji: 'ğŸŒ¸' },    
            { word: 'Ø®ÙØ±ÙÙŠÙ', color: colors[3], emoji: 'ğŸ‚' },    
            { word: 'Ù…ÙØ·ÙØ±', color: colors[4], emoji: 'ğŸŒ§ï¸' },    
            { word: 'Ø«ÙÙ„Ù’Ø¬', color: colors[5], emoji: 'â˜ƒï¸' },    
            { word: 'Ù…ÙØ´Ù’Ù…ÙØ³', color: colors[6], emoji: 'ğŸ˜' },   
            { word: 'Ø­ÙØ§Ø±Ù‘', color: colors[7], emoji: 'ğŸŒ¡ï¸' }     // Åeddeli
        ],
        // Seviye 2: KÄ±yafetler ve Aksesuarlar
        [
            { word: 'Ù…ÙØ¹Ù’Ø·ÙÙ', color: colors[0], emoji: 'ğŸ§¥' },   
            { word: 'Ù‚ÙÙ…ÙÙŠØµ', color: colors[1], emoji: 'ğŸ‘•' },   
            { word: 'ÙÙØ³Ù’ØªÙØ§Ù†', color: colors[2], emoji: 'ğŸ‘—' },   
            { word: 'Ù‚ÙØ¨Ù‘ÙØ¹ÙØ©', color: colors[3], emoji: 'ğŸ§¢' },   // Åeddeli
            { word: 'Ù…ÙØ¸ÙÙ„Ù‘ÙØ©', color: colors[4], emoji: 'â˜‚ï¸' },   // Åeddeli
            { word: 'Ù‚ÙÙÙ‘ÙØ§Ø²', color: colors[5], emoji: 'ğŸ§¤' },   // Åeddeli
            { word: 'ÙˆÙØ´ÙØ§Ø­', color: colors[6], emoji: 'ğŸ§£' },   
            { word: 'ØªÙÙ†Ù‘ÙÙˆØ±ÙØ©', color: colors[7], emoji: 'ğŸ‘š' }   // Åeddeli
        ],
        // Seviye 3: AlÄ±ÅŸveriÅŸ ve EÅŸyalar
        [
            { word: 'Ø³ÙÙˆÙ‚', color: colors[0], emoji: 'ğŸª' },    
            { word: 'Ø¨ÙØ§Ø¦ÙØ¹', color: colors[1], emoji: 'ğŸ‘¨â€ğŸ’¼' },   
            { word: 'Ù†ÙÙ‚ÙÙˆØ¯', color: colors[2], emoji: 'ğŸ’µ' },   
            { word: 'Ø¨ÙØ·ÙØ§Ù‚ÙØ©', color: colors[3], emoji: 'ğŸ’³' },   
            { word: 'Ø³ÙØ¹Ù’Ø±', color: colors[4], emoji: 'ğŸ·ï¸' },    
            { word: 'Ø­ÙØ§Ø³ÙÙˆØ¨', color: colors[5], emoji: 'ğŸ’»' },  
            { word: 'Ø¬ÙÙˆÙ‘ÙØ§Ù„', color: colors[6], emoji: 'ğŸ“±' },   // Åeddeli
            { word: 'Ø¨ÙÙ‚Ù‘ÙØ§Ù„ÙØ©', color: colors[7], emoji: 'ğŸ›’' }   // Åeddeli
        ]
    ];

    const arabicLetters = 'Ø£Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙŠ'.split('');
    
    // SÄ°METRÄ° AYARI: 10x10 Kare Izgara
    const desktopGridCols = 10;
    const desktopGridRows = 10; 
    
    let activeGridCols;
    let activeGridRows;
    let activeLevelSet;

    // --- Gerekli Elementler ---
    const gridContainer = document.getElementById('puzzle-grid-container');
    const wordListElement = document.getElementById('word-list');
    const instructionText = document.getElementById('instruction-text');
    const feedbackOverlay = document.getElementById('feedback-overlay');
    const feedbackIcon = document.getElementById('feedback-icon');
    
    // --- Ses DeÄŸiÅŸkenleri ---
    let audioCtx = null;

    // --- Durum DeÄŸiÅŸkenleri ---
    let grid = []; 
    let gridCells = [];
    let currentLevel = 0; 
    let processedLevelData = []; 
    let foundWords = [];
    let isSelecting = false;
    let selectionStart = null;
    let currentSelection = [];
    
    function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // --- ArapÃ§a Kelime Ä°ÅŸleme ---
    function processArabicWord(rawWord) {
        const vowelsRegex = /[\u064B-\u0650\u0652\u0670]/g;
        
        let listDisplay = rawWord.replace(vowelsRegex, '');

        let gridSequence = [];
        for (let i = 0; i < rawWord.length; i++) {
            const char = rawWord[i];
            
            if (char === '\u0651') { 
                if (gridSequence.length > 0) {
                    gridSequence.push(gridSequence[gridSequence.length - 1]);
                }
            } else if (vowelsRegex.test(char)) {
                continue;
            } else {
                gridSequence.push(char);
            }
        }

        return {
            original: rawWord,
            display: listDisplay,    
            gridChars: gridSequence  
        };
    }

    function startAndFullscreen() {
        const startScreen = document.getElementById('start-screen');
        const el = document.documentElement;
        initAudioContext();

        if (el.requestFullscreen) {
            el.requestFullscreen().catch(err => console.log(err));
        } else if (el.mozRequestFullScreen) {
            el.mozRequestFullScreen();
        } else if (el.webkitRequestFullscreen) {
            el.webkitRequestFullscreen();
        } else if (el.msRequestFullscreen) {
            el.msRequestFullscreen();
        }

        startScreen.style.opacity = '0';
        setTimeout(() => {
            startScreen.style.display = 'none';
        }, 500);
    }

    // --- SES ---
    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    
    function playSound(type) {
        if (!audioCtx) return; 
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'select') { 
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(400, now);
            gainNode.gain.setValueAtTime(0.05, now);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
            oscillator.start(now);
            oscillator.stop(now + 0.1);
        } else if (type === 'correct') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, now);
            oscillator.frequency.linearRampToValueAtTime(880, now + 0.2);
            gainNode.gain.setValueAtTime(0.15, now);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
            oscillator.start(now);
            oscillator.stop(now + 0.2);
        } else if (type === 'incorrect') {
            oscillator.type = 'triangle'; 
            oscillator.frequency.setValueAtTime(200, now);
            oscillator.frequency.linearRampToValueAtTime(100, now + 0.2);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
            oscillator.start(now);
            oscillator.stop(now + 0.2);
        }
    }
    
    // --- OYUN KURULUMU ---

    function initializeGame() {
        const rawLevelData = activeLevelSet[currentLevel];
        
        processedLevelData = rawLevelData.map(item => {
            const processed = processArabicWord(item.word);
            return {
                id: item.word, 
                color: item.color,
                emoji: item.emoji,
                displayWord: processed.display, 
                gridTarget: processed.gridChars 
            };
        });

        foundWords = [];
        grid = [];
        gridCells = [];
        gridContainer.innerHTML = '';
        wordListElement.innerHTML = '';
        feedbackOverlay.classList.remove('show');
        
        instructionText.textContent = "Ø§ÙØ¨Ù’Ø­ÙØ«Ù’ Ø¹ÙÙ† Ø§Ù„ÙƒÙÙ„ÙÙ…Ø§Øªâ€«.â€¬";

        renderWordList();
        
        for (let r = 0; r < activeGridRows; r++) {
            grid[r] = [];
            gridCells[r] = [];
            for (let c = 0; c < activeGridCols; c++) {
                grid[r][c] = null;
            }
        }

        placeWords();
        fillEmptyCells();
        renderGrid();
    }

    function renderWordList() {
        processedLevelData.forEach(data => {
            const li = document.createElement('li');
            li.className = 'word-list-item';
            li.id = `word-item-${data.id.replace(/\s/g, '-')}`; 
            li.textContent = `${data.emoji} ${data.displayWord}`;
            li.dataset.color = data.color; 
            wordListElement.appendChild(li);
        });
    }
    
    function placeWords() {
        // YÃ–NLER (Ters ve DÃ¼z)
        const directions = [
            { dr: 0, dc: 1 },   // Yatay (SaÄŸdan Sola)
            { dr: 1, dc: 0 },   // Dikey (YukarÄ±dan AÅŸaÄŸÄ±)
            { dr: 1, dc: 1 },   // Ã‡apraz (SaÄŸ Ãœst -> Sol Alt)
            { dr: -1, dc: 0 }   // Dikey Ters (AÅŸaÄŸÄ±dan YukarÄ±) - SÄ°METRÄ° Ä°Ã‡Ä°N
        ];

        const sortedWords = [...processedLevelData].sort((a, b) => b.gridTarget.length - a.gridTarget.length);

        for (const data of sortedWords) {
            let placed = false;
            let attempts = 0;
            const wordChars = data.gridTarget; 
            
            while (!placed && attempts < 150) {
                attempts++;
                const dir = directions[Math.floor(Math.random() * directions.length)];
                const r = Math.floor(Math.random() * activeGridRows);
                const c = Math.floor(Math.random() * activeGridCols);

                if (canPlaceWord(wordChars, r, c, dir)) {
                    for (let i = 0; i < wordChars.length; i++) {
                        grid[r + i * dir.dr][c + i * dir.dc] = wordChars[i];
                    }
                    placed = true;
                }
            }
        }
    }
    
    function canPlaceWord(wordChars, r, c, dir) {
        for (let i = 0; i < wordChars.length; i++) {
            const newRow = r + i * dir.dr;
            const newCol = c + i * dir.dc;

            if (newRow >= activeGridRows || newCol >= activeGridCols || newRow < 0 || newCol < 0) {
                return false;
            }
            const cell = grid[newRow][newCol];
            if (cell !== null && cell !== wordChars[i]) { 
                return false;
            }
        }
        return true;
    }

    function fillEmptyCells() {
        for (let r = 0; r < activeGridRows; r++) {
            for (let c = 0; c < activeGridCols; c++) {
                if (grid[r][c] === null) {
                    grid[r][c] = arabicLetters[Math.floor(Math.random() * arabicLetters.length)];
                }
            }
        }
    }

    function renderGrid() {
        gridContainer.innerHTML = ''; 
        
        for (let r = 0; r < activeGridRows; r++) {
            for (let c = 0; c < activeGridCols; c++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.textContent = grid[r][c];
                cell.dataset.row = r;
                cell.dataset.col = c;
                
                gridContainer.appendChild(cell);
                gridCells[r][c] = cell; 
            }
        }

        gridContainer.addEventListener('mousedown', (e) => {
            e.preventDefault(); 
            handleSelectionStart(e); 
        });
        gridContainer.addEventListener('mousemove', (e) => {
            handleSelectionMove(e); 
        });
        
        gridContainer.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            handleSelectionStart(e.touches[0]); 
        }, { passive: false });
        gridContainer.addEventListener('touchmove', (e) => {
            e.preventDefault(); 
            handleSelectionMove(e.touches[0]); 
        }, { passive: false });
        
        document.removeEventListener('mouseup', handleSelectionEnd);
        document.addEventListener('mouseup', handleSelectionEnd);
        
        document.removeEventListener('touchend', handleSelectionEnd);
        document.addEventListener('touchend', handleSelectionEnd);
    }

    // --- SEÃ‡Ä°M MANTIÄI ---
    function getCellFromEvent(e) {
        if (e.clientX && e.clientY) {
            const element = document.elementFromPoint(e.clientX, e.clientY);
            if (element && element.classList.contains('grid-cell')) {
                return element;
            }
        }
            if (e.target && e.target.classList.contains('grid-cell')) {
            return e.target;
        }
        return null;
    }

    function handleSelectionStart(e) {
        const cell = getCellFromEvent(e);
        if (!cell || !cell.dataset) return;

        isSelecting = true;
        selectionStart = { row: parseInt(cell.dataset.row), col: parseInt(cell.dataset.col) };
        currentSelection = [cell];
        cell.classList.add('selecting');
        playSound('select');
    }

    function handleSelectionMove(e) {
        if (!isSelecting) return;
        
        const cell = getCellFromEvent(e);
        if (!cell || !cell.dataset) return;

        if (currentSelection.length > 0 && currentSelection[currentSelection.length - 1] === cell) {
            return;
        }

        currentSelection.forEach(c => c.classList.remove('selecting'));
        
        const start = selectionStart;
        const end = { row: parseInt(cell.dataset.row), col: parseInt(cell.dataset.col) };

        currentSelection = getCellsInLine(start, end);
        currentSelection.forEach(c => c.classList.add('selecting'));
    }

    function handleSelectionEnd() {
        if (!isSelecting) return;
        isSelecting = false;
        
        checkSelection();
        
        currentSelection.forEach(c => c.classList.remove('selecting'));
        currentSelection = [];
        selectionStart = null;
    }
    
    function getCellsInLine(start, end) {
        const line = [];
        const diff_r = end.row - start.row;
        const diff_c = end.col - start.col;
        const abs_r = Math.abs(diff_r);
        const abs_c = Math.abs(diff_c);
        let dir_r, dir_c; 

        if (abs_c > abs_r) { 
            dir_r = 0;
            dir_c = Math.sign(diff_c);
        } else if (abs_r > abs_c) { 
            dir_r = Math.sign(diff_r);
            dir_c = 0;
        } else { 
            dir_r = Math.sign(diff_r);
            dir_c = Math.sign(diff_c);
        }
        
        const steps = Math.max(abs_r, abs_c);
        
        for (let i = 0; i <= steps; i++) {
            let r = start.row + i * dir_r;
            let c = start.col + i * dir_c;
            if (gridCells[r] && gridCells[r][c]) {
                line.push(gridCells[r][c]);
            } else {
                break; 
            }
        }
        return line;
    }
    
    // --- KONTROL ---
    function checkSelection() {
        if (currentSelection.length < 2) return;
        
        const selectedText = currentSelection.map(cell => cell.textContent).join('');
        const selectedTextReversed = currentSelection.map(cell => cell.textContent).reverse().join('');
        
        let found = false;
        
        for (const data of processedLevelData) {
            if (foundWords.includes(data.id)) continue; 
            
            const target = data.gridTarget.join(''); 
            
            if (target === selectedText || target === selectedTextReversed) {
                markAsFound(data); 
                found = true;
                break;
            }
        }
        
        if (!found) {
            playSound('incorrect');
        }
    }
    
    function markAsFound(data) {
        playSound('correct');
        
        const listItem = document.getElementById(`word-item-${data.id.replace(/\s/g, '-')}`);
        const color = data.color;
        
        currentSelection.forEach(cell => {
            cell.classList.add('found');
            cell.style.backgroundColor = color; 
        });
        
        if (listItem) {
            listItem.classList.add('found');
            listItem.style.color = color; 
        }
        
        foundWords.push(data.id);
        
        if (foundWords.length === processedLevelData.length) {
            setTimeout(showWinScreen, 1000);
        }
    }

    // --- BitiÅŸ ve Yeniden BaÅŸlatma ---
    function showWinScreen() {
        const replayBtn = document.getElementById('replay-button-end');
        
        feedbackIcon.textContent = 'âœ”';
        feedbackIcon.className = 'correct';
        feedbackOverlay.classList.add('show');

        currentLevel++; 

        if (currentLevel < activeLevelSet.length) {
            instructionText.textContent = "Ø£ÙØ­Ù’Ø³ÙÙ†Ù’Øª! Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ..."; 
            replayBtn.style.display = 'none';

            setTimeout(() => {
                feedbackOverlay.classList.remove('show');
                initializeGame();
            }, 2000);

        } else {
            currentLevel = 0; 
            instructionText.textContent = "Ù…ÙØ¨ÙØ§Ø±ÙÙƒ! Ù„ÙÙ‚ÙØ¯ Ø£ÙÙ†Ù’Ù‡ÙÙŠÙ’ØªÙ Ø§Ù„Ù„Ù‘ÙØ¹Ù’Ø¨ÙØ©"; 
            replayBtn.style.display = 'block';
        }
    }

    function restartGame() {
        playSound('select');
        initializeGame();
    }

    // --- Fullscreen Setup ---
    function setupFullscreen() {
        const fsBtn = document.getElementById('fullscreen-btn');
        if (!fsBtn) return;

        fsBtn.addEventListener('click', () => {
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                const el = document.documentElement;
                if (el.requestFullscreen) {
                    el.requestFullscreen();
                } else if (el.mozRequestFullScreen) {
                    el.mozRequestFullScreen();
                } else if (el.webkitRequestFullscreen) {
                    el.webkitRequestFullscreen();
                } else if (el.msRequestFullscreen) {
                    el.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });

        function handleFullscreenChange() {
            if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                document.body.classList.add('fullscreen');
            } else {
                document.body.classList.remove('fullscreen');
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);
    }
    
    // --- BaÅŸlangÄ±Ã§ ---
    document.addEventListener('DOMContentLoaded', () => {
        activeLevelSet = allLevelsData;
        activeGridCols = desktopGridCols;
        activeGridRows = desktopGridRows;
        
        const rootStyle = document.documentElement.style;
        rootStyle.setProperty('--grid-size-cols', activeGridCols);
        rootStyle.setProperty('--grid-size-rows', activeGridRows);

        initializeGame();
        setupFullscreen(); 
    });

</script>
</body>
</html>